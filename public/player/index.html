<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splenderra : Legend IA - Joueur</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Écran de connexion -->
    <div id="loginScreen" class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8">Splenderra : Legend IA</h1>
        <div class="max-w-md mx-auto bg-gray-800 rounded-lg p-6">
            <input type="text" id="gameCodeInput" placeholder="Code de partie" 
                class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg mb-4">
            <input type="text" id="playerNameInput" placeholder="Ton pseudo" 
                class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg mb-4">
            <button id="joinGame" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">
                Rejoindre la partie
            </button>
        </div>
    </div>

    <!-- Écran de jeu -->
    <div id="gameScreen" class="hidden container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto">
            <!-- En-tête joueur -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="playerName" class="text-xl font-bold"></h2>
                        <div id="playerScore" class="text-purple-400"></div>
                    </div>
                    <div>
                        <span id="jokerStatus" class="bg-green-600 px-3 py-1 rounded-full">Joker disponible</span>
                    </div>
                </div>
            </div>

            <!-- Mission en cours -->
            <div id="currentMission" class="bg-gray-800 rounded-lg p-6 mb-4 hidden">
                <h3 class="text-xl font-bold mb-2">Mission en cours</h3>
                <div id="currentPlayer" class="text-purple-400 mb-4"></div>
                <p id="missionText" class="mb-4"></p>
                <p id="suggestionText" class="text-gray-400"></p>
                <div id="timerDisplay" class="text-2xl font-bold mt-4 text-center">2:00</div>
            </div>

            <!-- Section de vote -->
            <div id="voteSection" class="bg-gray-800 rounded-lg p-6 mb-4 hidden">
                <h3 class="text-xl font-bold mb-4">Vote</h3>
                <p class="mb-4">As-tu été convaincu(e) par la performance ?</p>
                <button id="voteYes" class="w-full bg-green-600 text-white py-3 rounded-lg mb-2 hover:bg-green-700">
                    Voter OUI (1 point)
                </button>
                <div class="text-sm text-gray-400 text-center">
                    Tu as <span id="credibilityPoints">1</span> point(s) de crédibilité
                </div>
            </div>

            <!-- Section Joker -->
            <div id="jokerSection" class="bg-gray-800 rounded-lg p-6 mb-4">
                <h3 class="text-xl font-bold mb-4">Joker</h3>
                <p class="mb-4">Tu peux utiliser ton Joker pour impliquer un autre joueur dans ta performance (une seule fois par partie)</p>
                <select id="jokerTarget" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg mb-4">
                    <option value="">Choisir un joueur</option>
                </select>
                <button id="useJoker" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                    Utiliser mon Joker
                </button>
            </div>

            <!-- Liste des joueurs -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Joueurs</h3>
                <div id="playersList"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let playerData = {
            id: null,
            name: '',
            gameCode: '',
            hasJoker: true,
            credibilityPoints: 1,
            score: 0
        };

        // Rejoindre une partie
        document.getElementById('joinGame').addEventListener('click', () => {
            const gameCode = document.getElementById('gameCodeInput').value.trim().toUpperCase();
            const playerName = document.getElementById('playerNameInput').value.trim();
            
            if (!gameCode || !playerName) {
                alert('Remplis tous les champs');
                return;
            }
            
            playerData.gameCode = gameCode;
            playerData.name = playerName;
            
            socket.emit('joinGame', gameCode, playerName);
        });

        // Voter
        document.getElementById('voteYes').addEventListener('click', () => {
            if (playerData.credibilityPoints < 1) {
                alert('Tu n\'as plus de points de crédibilité');
                return;
            }
            
            socket.emit('vote', playerData.gameCode, playerData.id, playerData.currentPlayer);
            document.getElementById('voteSection').classList.add('hidden');
        });

        // Utiliser Joker
        document.getElementById('useJoker').addEventListener('click', () => {
            if (!playerData.hasJoker) {
                alert('Tu as déjà utilisé ton Joker');
                return;
            }
            
            const targetId = document.getElementById('jokerTarget').value;
            if (!targetId) {
                alert('Choisis un joueur');
                return;
            }
            
            socket.emit('useJoker', playerData.gameCode, playerData.id, targetId);
        });

        // Afficher l'écran de jeu
        function showGameScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('playerName').textContent = playerData.name;
            updatePlayerScore();
        }

        // Mettre à jour le score
        function updatePlayerScore() {
            document.getElementById('playerScore').textContent = `${playerData.score} points`;
            document.getElementById('credibilityPoints').textContent = playerData.credibilityPoints;
            
            if (!playerData.hasJoker) {
                document.getElementById('jokerStatus').classList.remove('bg-green-600');
                document.getElementById('jokerStatus').classList.add('bg-gray-600');
                document.getElementById('jokerStatus').textContent = 'Joker utilisé';
            }
        }

        // Mettre à jour la liste des joueurs
        function updatePlayersList(players) {
            const container = document.getElementById('playersList');
            const jokerSelect = document.getElementById('jokerTarget');
            
            // Vider les listes
            container.innerHTML = '';
            jokerSelect.innerHTML = '<option value="">Choisir un joueur</option>';
            
            players.forEach(player => {
                // Liste principale
                const playerDiv = document.createElement('div');
                playerDiv.className = `flex justify-between items-center py-2 ${player.isConnected ? '' : 'opacity-50'}`;
                playerDiv.innerHTML = `
                    <span class="font-medium">${player.name}</span>
                    <span class="bg-purple-600 px-3 py-1 rounded-full">${player.score} pts</span>
                `;
                container.appendChild(playerDiv);
                
                // Liste du Joker (exclure le joueur actuel)
                if (player._id !== playerData.id && player.isConnected) {
                    const option = document.createElement('option');
                    option.value = player._id;
                    option.textContent = player.name;
                    jokerSelect.appendChild(option);
                }
            });
        }

        // Socket events
        socket.on('connect', () => {
            console.log('Connecté au serveur');
        });

        socket.on('gameState', (data) => {
            showGameScreen();
            updatePlayersList(data.players);
        });

        socket.on('playerJoined', (player) => {
            if (player.id === socket.id) {
                playerData.id = player.id;
                showGameScreen();
            }
        });

        socket.on('turnStarted', (data) => {
            playerData.currentPlayer = data.currentPlayer;
            
            const missionDiv = document.getElementById('currentMission');
            const voteSection = document.getElementById('voteSection');
            
            missionDiv.classList.remove('hidden');
            document.getElementById('currentPlayer').textContent = 
                `Joueur actuel : ${data.playerName}`;
            document.getElementById('missionText').textContent = data.mission.task;
            document.getElementById('suggestionText').textContent = data.mission.suggestion;
            
            // Afficher les votes seulement si ce n'est pas notre tour
            if (data.currentPlayer !== playerData.id) {
                voteSection.classList.remove('hidden');
            } else {
                voteSection.classList.add('hidden');
            }
        });

        socket.on('timerUpdate', (timeLeft) => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });

        socket.on('scoreUpdate', (data) => {
            updatePlayersList(data.players);
            const player = data.players.find(p => p._id === playerData.id);
            if (player) {
                playerData.score = player.score;
                playerData.credibilityPoints = player.credibilityPoints;
                updatePlayerScore();
            }
        });

        socket.on('jokerUsed', (data) => {
            if (data.playerId === playerData.id) {
                playerData.hasJoker = false;
                updatePlayerScore();
            }
            alert(`${data.playerName} a utilisé son Joker !`);
        });

        socket.on('error', (message) => {
            alert(message);
        });
    </script>
</body>
</html>